const getUsers = async () => {
  try {
    const response = await fetch('/api/users');
    const data = await response.json();
    return data;
  } catch (err) {
    console.error('Error fetching users', err);
    return [];
  }
};

const connectedUser = document.getElementById('agentTR')
const selectedUsersDiv = document.getElementById('selectedUsers');
const dropdown = document.getElementById('dropdown');
const userList = document.getElementById('userList');
const searchInput = document.getElementById('equipe');

let selectedUsers = [];

// Update the input value to match selected users
function updateEquipeInput() {
  searchInput.value = selectedUsers.map(u => u.id).join('_');
}

function renderDropdown(list) {
  userList.innerHTML = '';
  list.forEach(user => {
    const li = document.createElement('li');
    var uname = `${user.firstname ?? ''} ${user.lastname ?? ''} ${user.middlename ?? ''}`;
    li.textContent = `${uname}`;
    li.addEventListener('click', () => {
      if (!selectedUsers.find(u => u.id === user.id)) {
        selectedUsers.push(user);
        renderSelected();
        updateEquipeInput();
      }
      dropdown.style.display = 'none';
    });
    userList.appendChild(li);
  });
}

function renderSelected() {
  selectedUsersDiv.innerHTML = '';
  selectedUsers.forEach(user => {
    const tag = document.createElement('div');
    tag.className = 'tag';
    tag.innerHTML = `${user.firstname ?? ''} ${user.lastname ?? ''} ${user.middlename ?? ''} <span class="remove">&times;</span>`;
    tag.querySelector('.remove').addEventListener('click', () => {
      selectedUsers = selectedUsers.filter(u => u.id !== user.id);
      renderSelected();
      updateEquipeInput();
    });
    selectedUsersDiv.appendChild(tag);
  });
}

getUsers().then(users => {
  console.log("Users Data:", users);

  selectedUsersDiv.addEventListener('click', () => {
    dropdown.style.display = 'block';
    searchInput.value = '';
    renderDropdown(users);
    searchInput.focus();
  });

  searchInput.addEventListener('input', () => {
    const term = searchInput.value.toLowerCase();
    const filtered = users.filter(user =>
      user.id.toString().includes(term) ||
      `${user.firstname ?? ''} ${user.lastname ?? ''} ${user.middlename ?? ''}`.toLowerCase().includes(term)
    );
    renderDropdown(filtered);
  });

  document.addEventListener('click', (e) => {
    if (!document.querySelector('.team-selector').contains(e.target)) {
      dropdown.style.display = 'none';
    }
  });

  // Initialize dropdown
  renderDropdown(users);
});
