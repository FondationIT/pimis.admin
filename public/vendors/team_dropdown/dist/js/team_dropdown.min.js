document.addEventListener('DOMContentLoaded', () => {

    const selector     = document.querySelector('.team-selector');
    const selectedBox  = document.getElementById('selectedUsers');
    const dropdown     = document.getElementById('team_dropdown');
    const searchInput  = document.getElementById('equipe');
    const userList     = document.getElementById('userList');
    const manualBox    = document.getElementById('manualBox');
    const manualInput  = document.getElementById('manualNames');

    let selectedUsers = [];

    /* ------------------------------
       OPEN DROPDOWN
    --------------------------------*/
    selectedBox.addEventListener('click', e => {
        e.stopPropagation();
        dropdown.classList.remove('d-none');
        searchInput.focus();
    });

    /* ------------------------------
       CLOSE DROPDOWN (OUTSIDE CLICK)
    --------------------------------*/
    document.addEventListener('click', e => {
        if (!e.target.closest('.team-selector')) {
            closeDropdown();
        }
    });

    function closeDropdown() {
        dropdown.classList.add('d-none');
        manualBox.style.display = 'none';
        searchInput.value = '';
        resetList();
    }

    /* ------------------------------
       SEARCH FILTER
    --------------------------------*/
    searchInput.addEventListener('input', () => {
        const q = searchInput.value.toLowerCase().trim();
        let hasMatch = false;

        [...userList.children].forEach(li => {
            if (!li.dataset.id) return;

            const haystack = (li.dataset.name + ' ' + li.dataset.id).toLowerCase();
            const match = haystack.includes(q);

            li.style.display = match ? 'block' : 'none';
            if (match) hasMatch = true;
        });

        manualBox.style.display = (!hasMatch && q.length > 0)
            ? 'block'
            : 'none';
    });

    /* ------------------------------
       RESET LIST
    --------------------------------*/
    function resetList() {
        [...userList.children].forEach(li => {
            li.style.display = 'block';
        });
    }

    /* ------------------------------
       SELECT USER
    --------------------------------*/
    userList.addEventListener('click', e => {
        const li = e.target.closest('.tdr_team_user');
        if (!li) return;

        const id   = Number(li.dataset.id);
        const name = li.dataset.name;
        const type = li.dataset.agentType;

        if (selectedUsers.some(u => u.id === id)) return;

        selectedUsers.push({ id, name, type });
        li.classList.add('selected');

        renderSelected();
        closeDropdown();
    });

    /* ------------------------------
       RENDER SELECTED USERS
    --------------------------------*/
    function renderSelected() {
        selectedBox.innerHTML = '';

        if (!selectedUsers.length) {
            selectedBox.innerHTML =
                '<span class="placeholder">Cliquez pour sélectionner une équipe</span>';
            return;
        }

        selectedUsers.forEach(user => {
            const tag = document.createElement('span');
            tag.className = 'team-tag';
            tag.innerHTML = `
                ${user.name}
                <button type="button" data-id="${user.id}">&times;</button>
                <input type="hidden" name="equipe[]" data-type="${user.type}" value="${user.id}">
            `;
            selectedBox.appendChild(tag);
        });
    }

    /* ------------------------------
       REMOVE SELECTED USER
    --------------------------------*/
    selectedBox.addEventListener('click', e => {
        if (e.target.tagName !== 'BUTTON') return;

        e.stopPropagation();

        const id = Number(e.target.dataset.id);
        selectedUsers = selectedUsers.filter(u => u.id !== id);

        const li = userList.querySelector(`[data-id="${id}"]`);
        if (li) li.classList.remove('selected');

        renderSelected();
    });

    /* ------------------------------
       MANUAL ENTRY
    --------------------------------*/
    // manualInput.addEventListener('blur', () => {
    //     const names = manualInput.value
    //         .split(',')
    //         .map(n => n.trim())
    //         .filter(Boolean);


    //     names.forEach(name => {
    //         selectedUsers.push({ id: null, name });
    //     });
    //     manualInput.value = '';
    //     renderSelected();
    // });

    // Initial placeholder
    renderSelected();
});