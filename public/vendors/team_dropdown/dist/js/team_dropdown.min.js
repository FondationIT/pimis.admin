const getUsers = async () => {
  try {
    const response = await fetch('/api/users');
    const data = await response.json();
    return data;
  } catch (err) {
    console.error('Error fetching users', err);
    return [];
  }
};

const getOtherTeam = async () => {
  const res = await fetch('/tdr-other-agents');
  return await res.json();
};

const selectedUsersDiv = document.getElementById('selectedUsers');
const dropdown = document.getElementById('team_dropdown');
const userList = document.getElementById('userList');
const searchInput = document.getElementById('equipe');
const manualBox = document.getElementById('manualBox');
const manualInput = document.getElementById('manualNames');

let selectedUsers = [];
let currentSource = 'users'; // users | other
let usersCache = [];
let otherCache = [];


// const connectedUser = document.getElementById('agentTR')
// const selectedUsersDiv = document.getElementById('selectedUsers');
// const dropdown = document.getElementById('team_dropdown');
// const userList = document.getElementById('userList');
// const searchInput = document.getElementById('equipe');

// let selectedUsers = [];

// Update the input value to match selected users
// function updateEquipeInput() {
//   searchInput.value = selectedUsers.map(u => u.id).join('_');
// }

function updateEquipeInput() {
  const ids = selectedUsers.map(u => u.id ?? u.name);
  searchInput.value = ids.join('_');
}
function renderDropdown(list) {
  userList.innerHTML = '';

  // OTHER option
  const otherLi = document.createElement('li');
  otherLi.textContent = '➕ Other';
  otherLi.style.fontWeight = 'bold';
  otherLi.addEventListener('click', async () => {
    currentSource = 'other';
    manualBox.style.display = 'none';
    if (!otherCache.length) {
      otherCache = await getOtherTeam();
    }
    renderDropdown(otherCache);
  });
  userList.appendChild(otherLi);

  // Data items
  list.forEach(user => {
    const li = document.createElement('li');
    const name = `${user.firstname ?? ''} ${user.lastname ?? ''} ${user.middlename ?? ''}`.trim();

    li.textContent = name || user.name;

    li.addEventListener('click', () => {
      if (!selectedUsers.find(u => u.id === user.id || u.name === user.name)) {
        selectedUsers.push(user);
        renderSelected();
        updateEquipeInput();
      }
      dropdown.style.display = 'none';
    });

    userList.appendChild(li);
  });
}

function renderSelected() {
  selectedUsersDiv.innerHTML = '';

  selectedUsers.forEach(user => {
    const tag = document.createElement('div');
    tag.className = 'team-tag';

    const label = user.name ??
      `${user.firstname ?? ''} ${user.lastname ?? ''} ${user.middlename ?? ''}`;

    tag.innerHTML = `${label} <span class="remove">&times;</span>`;

    tag.querySelector('.remove').addEventListener('click', () => {
      selectedUsers = selectedUsers.filter(u => u !== user);
      renderSelected();
      updateEquipeInput();
    });

    selectedUsersDiv.appendChild(tag);
  });
}


searchInput.addEventListener('input', () => {
  const term = searchInput.value.toLowerCase();
  const source = currentSource === 'users' ? usersCache : otherCache;

  const filtered = source.filter(u => {
    const name = `${u.firstname ?? ''} ${u.lastname ?? ''} ${u.middlename ?? ''} ${u.name ?? ''}`.toLowerCase();
    return name.includes(term);
  });

  renderDropdown(filtered);

  // If OTHER + no match → show manual input
  if (currentSource === 'other' && filtered.length === 0) {
    manualBox.style.display = 'block';
  } else {
    manualBox.style.display = 'none';
  }
});


manualInput.addEventListener('blur', () => {
  const names = manualInput.value
    .split(',')
    .map(n => n.trim())
    .filter(n => n);

  names.forEach(name => {
    if (!selectedUsers.find(u => u.name === name)) {
      selectedUsers.push({ name });
    }
  });

  manualInput.value = '';
  manualBox.style.display = 'none';
  renderSelected();
  updateEquipeInput();
});


getUsers().then(users => {
  usersCache = users;

  selectedUsersDiv.addEventListener('click', () => {
    dropdown.style.display = 'block';
    renderDropdown(usersCache);
    searchInput.focus();
  });

  document.addEventListener('click', e => {
    if (!document.querySelector('.team-selector').contains(e.target)) {
      dropdown.style.display = 'none';
    }
  });
});



// function renderDropdown(list) {
//   userList.innerHTML = '';
//   list.forEach(user => {
//     const li = document.createElement('li');
//     var uname = `${user.firstname ?? ''} ${user.lastname ?? ''} ${user.middlename ?? ''}`;
//     li.textContent = `${uname}`;
//     li.addEventListener('click', () => {
//       if (!selectedUsers.find(u => u.id === user.id)) {
//         selectedUsers.push(user);
//         renderSelected();
//         updateEquipeInput();
//       }
//       dropdown.style.display = 'none';
//     });
//     userList.appendChild(li);
//   });
// }

// function renderSelected() {
//   selectedUsersDiv.innerHTML = '';
//   selectedUsers.forEach(user => {
//     const tag = document.createElement('div');
//     tag.className = 'team-tag';
//     tag.innerHTML = `${user.firstname ?? ''} ${user.lastname ?? ''} ${user.middlename ?? ''} <span class="remove">&times;</span>`;
//     tag.querySelector('.remove').addEventListener('click', () => {
//       selectedUsers = selectedUsers.filter(u => u.id !== user.id);
//       renderSelected();
//       updateEquipeInput();
//     });
//     selectedUsersDiv.appendChild(tag);
//   });
// }

// getUsers().then(users => {
//   console.log("Users Data:", users);

//   selectedUsersDiv.addEventListener('click', () => {
//     dropdown.style.display = 'block';
//     searchInput.value = '';
//     renderDropdown(users);
//     searchInput.focus();
//   });

//   searchInput.addEventListener('input', () => {
//     const term = searchInput.value.toLowerCase();
//     const filtered = users.filter(user =>
//       user.id.toString().includes(term) ||
//       `${user.firstname ?? ''} ${user.lastname ?? ''} ${user.middlename ?? ''}`.toLowerCase().includes(term)
//     );
//     renderDropdown(filtered);
//   });

//   document.addEventListener('click', (e) => {
//     if (!document.querySelector('.team-selector').contains(e.target)) {
//       dropdown.style.display = 'none';
//     }
//   });

//   // Initialize dropdown
//   renderDropdown(users);
// });
